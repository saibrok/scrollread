#!/bin/bash
# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´ÐµÐ¿Ð»Ð¾Ñ Ñ„Ñ€Ð¾Ð½Ñ‚ÐµÐ½Ð´Ð°
# - Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¸ ÑÐ¾Ð±Ð¸Ñ€Ð°ÐµÑ‚ Vite-Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
# - ÐÑ€Ñ…Ð¸Ð²Ð¸Ñ€ÑƒÐµÑ‚ Ð¿Ð°Ð¿ÐºÑƒ dist Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÑ‚ Ð½Ð° ÑƒÐ´Ð°Ð»ÐµÐ½Ð½Ñ‹Ð¹ ÑÐµÑ€Ð²ÐµÑ€ (/tmp) Ñ‡ÐµÑ€ÐµÐ· scp
# - Ð—Ð°Ð¼ÐµÐ½ÑÐµÑ‚ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ ÑƒÐ´Ð°Ð»ÐµÐ½Ð½Ð¾Ð¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ /var/www/scrollread.ru Ð½Ð¾Ð²Ð¾Ð¹ ÑÐ±Ð¾Ñ€ÐºÐ¾Ð¹
# - ÐžÑ‡Ð¸Ñ‰Ð°ÐµÑ‚ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ‹
set -euo pipefail

# ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ Ñ†Ð²ÐµÑ‚Ð¾Ð² Ð´Ð»Ñ ÐºÑ€Ð°ÑÐ¸Ð²Ð¾Ð³Ð¾ Ð²Ñ‹Ð²Ð¾Ð´Ð° Ð² ÐºÐ¾Ð½ÑÐ¾Ð»Ð¸
RED='\033[0;31m'      # ÐšÑ€Ð°ÑÐ½Ñ‹Ð¹ Ð´Ð»Ñ Ð¾ÑˆÐ¸Ð±Ð¾Ðº
GREEN='\033[0;32m'    # Ð—ÐµÐ»ÐµÐ½Ñ‹Ð¹ Ð´Ð»Ñ ÑƒÑÐ¿ÐµÑ…Ð°
YELLOW='\033[1;33m'   # Ð–ÐµÐ»Ñ‚Ñ‹Ð¹ Ð´Ð»Ñ Ð¿Ñ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ð¹
BLUE='\033[0;34m'     # Ð¡Ð¸Ð½Ð¸Ð¹ Ð´Ð»Ñ Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ¾Ð²
NC='\033[0m'          # Ð¡Ð±Ñ€Ð¾Ñ Ñ†Ð²ÐµÑ‚Ð° (No Color)

echo -e "\033[0;34mâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\033[0m"
echo -e "\033[0;34mâ•‘           ðŸŒ Ð”Ð•ÐŸÐ›ÐžÐ™ Ð¤Ð ÐžÐÐ¢Ð•ÐÐ”Ð        â•‘\033[0m"
echo -e "\033[0;34mâ•‘        scrollread Frontend Deployment      â•‘\033[0m"
echo -e "\033[0;34mâ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\033[0m"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ñ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ñ… ÑƒÑ‚Ð¸Ð»Ð¸Ñ‚ (scp, ssh, npm)
if ! command -v scp &> /dev/null || ! command -v ssh &> /dev/null; then
  echo -e "${RED}âš ï¸  ÐžÑˆÐ¸Ð±ÐºÐ°: scp Ð¸Ð»Ð¸ ssh Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Ð¸Ñ… Ð´Ð»Ñ Ð´ÐµÐ¿Ð»Ð¾Ñ.${NC}" >&2
  exit 1
fi
if ! command -v npm &> /dev/null; then
  echo -e "${RED}âš ï¸  ÐžÑˆÐ¸Ð±ÐºÐ°: npm Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Node.js Ð´Ð»Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð°.${NC}" >&2
  exit 1
fi

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð½Ð¾Ð³Ð¾ ÑÐµÑ€Ð²ÐµÑ€Ð°
SERVER="root@vpn.saibrok.ru"            # Ð¦ÐµÐ»ÑŒ SSH: Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ@Ñ…Ð¾ÑÑ‚
FRONTEND_DIR="/var/www/scrollread.ru" # ÐŸÑƒÑ‚ÑŒ Ðº Ñ„Ñ€Ð¾Ð½Ñ‚ÐµÐ½Ð´Ñƒ Ð½Ð° ÑƒÐ´Ð°Ð»ÐµÐ½Ð½Ð¾Ð¼ ÑÐµÑ€Ð²ÐµÑ€Ðµ

# ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð¿ÑƒÑ‚Ð¸ Ð´Ð»Ñ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð°Ñ€Ñ…Ð¸Ð²Ð°
ARCHIVE_PATH="$(cd "$(dirname "$0")" && pwd)/tmp"
FRONTEND_ARCHIVE="frontend-dist.tar.gz"

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð², ÐµÑÐ»Ð¸ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
mkdir -p "$ARCHIVE_PATH"

echo -e "${BLUE}ðŸš€ ==> Ð¨Ð°Ð³ 1/4: Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð¸ ÑÐ±Ð¾Ñ€ÐºÐ° Ñ„Ñ€Ð¾Ð½Ñ‚ÐµÐ½Ð´Ð°${NC}"
# ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ ÐºÐ¾Ñ€ÐµÐ½ÑŒ Ñ„Ñ€Ð¾Ð½Ñ‚ÐµÐ½Ð´Ð° Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ Ñ€Ð°ÑÐ¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð°
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
FRONTEND_ROOT="$SCRIPT_DIR"
cd "$FRONTEND_ROOT"
echo -e "    ðŸ“‚ ÐšÐ¾Ñ€ÐµÐ½ÑŒ Ñ„Ñ€Ð¾Ð½Ñ‚ÐµÐ½Ð´Ð°: $FRONTEND_ROOT"
# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¸ ÑÐ¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
echo -e "    ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
npm ci --silent
echo -e "    ðŸ› ï¸ Ð¡Ð±Ð¾Ñ€ÐºÐ° Vite-Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ..."
npm run build --silent
echo -e "    ${GREEN}âœ… Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°${NC}"

echo -e "${BLUE}ðŸš€ ==> Ð¨Ð°Ð³ 2/4: ÐÑ€Ñ…Ð¸Ð²Ð°Ñ†Ð¸Ñ Ð¿Ð°Ð¿ÐºÐ¸ dist${NC}"
# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ð°Ð¿ÐºÐ¸ dist
if [ ! -d "dist" ]; then
  echo -e "${RED}âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: Ð¿Ð°Ð¿ÐºÐ° dist Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ÑÑ‚ÑŒ ÑÐ±Ð¾Ñ€ÐºÐ¸.${NC}" >&2
  exit 1
fi
# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð°Ñ€Ñ…Ð¸Ð² Ð¸Ð· ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ð³Ð¾ Ð¿Ð°Ð¿ÐºÐ¸ dist
echo -e "    ðŸ“¦ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð°Ñ€Ñ…Ð¸Ð²..."
tar -C dist -czf "$ARCHIVE_PATH/$FRONTEND_ARCHIVE" .
echo -e "    ${GREEN}âœ… ÐÑ€Ñ…Ð¸Ð² ÑÐ¾Ð·Ð´Ð°Ð½: $ARCHIVE_PATH/$FRONTEND_ARCHIVE${NC}"

echo -e "${BLUE}ðŸš€ ==> Ð¨Ð°Ð³ 3/4: Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð°Ñ€Ñ…Ð¸Ð²Ð° Ð½Ð° $SERVER:/tmp${NC}"
# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð°Ñ€Ñ…Ð¸Ð²Ð° Ð¿ÐµÑ€ÐµÐ´ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¾Ð¹
if [ ! -f "$ARCHIVE_PATH/$FRONTEND_ARCHIVE" ]; then
  echo -e "${RED}âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: Ð°Ñ€Ñ…Ð¸Ð² $ARCHIVE_PATH/$FRONTEND_ARCHIVE Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½${NC}" >&2
  exit 1
fi
# Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð°Ñ€Ñ…Ð¸Ð² Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€ Ñ‡ÐµÑ€ÐµÐ· scp
echo -e "    ðŸ“¤ Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð°Ñ€Ñ…Ð¸Ð²Ð°..."
scp "$ARCHIVE_PATH/$FRONTEND_ARCHIVE" "$SERVER:/tmp/"
echo -e "    ${GREEN}âœ… Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°${NC}"

echo -e "${BLUE}ðŸš€ ==> Ð¨Ð°Ð³ 4/4: Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ð° ÑƒÐ´Ð°Ð»ÐµÐ½Ð½Ð¾Ð¼ Ñ…Ð¾ÑÑ‚Ðµ${NC}"
# Ð Ð°Ð·Ð²Ð¾Ñ€Ð°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ð°Ñ€Ñ…Ð¸Ð² Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
ssh "$SERVER" "
  set -e
  # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ñ„Ñ€Ð¾Ð½Ñ‚ÐµÐ½Ð´Ð°, ÐµÑÐ»Ð¸ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
  mkdir -p '$FRONTEND_DIR'
  echo -e '${YELLOW}  ðŸ§¹ Ð£Ð´Ð°Ð»ÐµÐ½Ð½Ð¾: Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ° ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ð³Ð¾ $FRONTEND_DIR${NC}'
  rm -rf '$FRONTEND_DIR'/*
  echo -e '${BLUE}  ðŸ“¦ Ð£Ð´Ð°Ð»ÐµÐ½Ð½Ð¾: Ð¸Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ðµ /tmp/$FRONTEND_ARCHIVE Ð² $FRONTEND_DIR${NC}'
  tar -xzf '/tmp/$FRONTEND_ARCHIVE' -C '$FRONTEND_DIR'
  rm -f '/tmp/$FRONTEND_ARCHIVE'
  echo -e '${GREEN}  âœ… Ð£Ð´Ð°Ð»ÐµÐ½Ð½Ð¾: Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½${NC}'
"

echo -e "${GREEN}ðŸ§¹ ==> ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ñ… Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð¾Ð²${NC}"
rm -f "$ARCHIVE_PATH/$FRONTEND_ARCHIVE"
echo -e "${GREEN}âœ… ==> Ð“Ð¾Ñ‚Ð¾Ð²Ð¾! Ð¤Ñ€Ð¾Ð½Ñ‚ÐµÐ½Ð´ Ð·Ð°Ð´ÐµÐ¿Ð»Ð¾ÐµÐ½ Ð² $FRONTEND_DIR${NC}"
